Cloudflare Tunnel Installation and Management Scripts

This repository contains a set of Bash scripts designed to streamline the installation, configuration, and uninstallation of Cloudflare Tunnel (cloudflared) on various Linux distributions, particularly useful for systems behind CGNAT (Carrier-Grade NAT).

üöÄ Project Goal

To expose a virtual machine or local service to the internet securely via Cloudflare Tunnel, bypassing ISP limitations like CGNAT.

üìÇ Scripts Overview

The project consists of five main scripts, each serving a specific purpose in the Cloudflare Tunnel lifecycle:

01-pre.sh: Pre-installation setup

02-access_check.sh: Cloudflare API access verification

03_install_cloudflare.sh: Cloudflare Tunnel installation

04_uninstall_cloudflare.sh: Cloudflare Tunnel uninstallation (older version, superseded by 05_uninstall_cloudflare.sh)

05_uninstall_cloudflare.sh: Cloudflare Tunnel uninstallation (multi-distribution support)

un-pre.sh: Pre-installation rollback

1. 01-pre.sh - Prerequisites Installation

This script prepares your Linux system by installing necessary dependencies for cloudflared and creating required directories and a dedicated user. It logs all changes for easy rollback using un-pre.sh.

Features:

Installs curl, wget, gnupg, lsb-release, ca-certificates, software-properties-common.

Creates a cloudflared system user (-r -s /bin/false -d /nonexistent).

Creates /etc/cloudflared and /var/log/cloudflared directories with appropriate ownership (cloudflared:cloudflared).

Logs all installations and file changes to /tmp/cloudflare_prereq_install.log.

Includes a root privilege check.

Usage:
sudo ./01-pre.sh

2. 02-access_check.sh - Cloudflare Account Access Verification

This script verifies that your Cloudflare API credentials (CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID) are correctly set as environment variables and can successfully connect to the Cloudflare API.

Features:

Checks for the presence and validity of CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID.

Provides clear instructions on how to set these environment variables if they are missing.

Tests API token validity and account access using curl (requires curl and jq for full output).

Masks sensitive API token values in output.

Does not require root privileges.

Usage:
# First, set your environment variables (e.g., in your shell or a .env file)
export CLOUDFLARE_API_TOKEN="YOUR_API_TOKEN_HERE"
export CLOUDFLARE_ACCOUNT_ID="YOUR_ACCOUNT_ID_HERE"

./02-access_check.sh

3. 03_install_cloudflare.sh - Cloudflare Tunnel Installation

This script downloads, installs, and configures the cloudflared binary and sets up its system service.

Features:

Detects system architecture (amd64, arm64, armhf, arm).

Downloads the latest cloudflared binary from GitHub.

Backs up existing cloudflared installations.

Installs cloudflared to /usr/local/bin/.

Creates a systemd service file (/etc/systemd/system/cloudflared.service).

Creates a sample configuration file (/etc/cloudflared/config.yml.sample).

Generates a helper script (/usr/local/bin/cloudflared-setup) to simplify tunnel creation and initial configuration.

Logs installation steps to /tmp/cloudflare_install.log.

Includes a root privilege check.

Usage:
sudo ./03_install_cloudflare.sh

4. 05_uninstall_cloudflare.sh - Cloudflare Tunnel Uninstallation (Multi-Distribution)

This script provides a comprehensive uninstallation process for cloudflared, designed to work across multiple Linux distributions and init systems. It removes the binary, configuration, logs, and optionally remote tunnels and the cloudflared user.

Features:

Multi-Distribution Support: Detects and handles uninstallation for Debian/Ubuntu/Armbian, CentOS/RHEL/Fedora/Rocky/AlmaLinux, Arch/Manjaro, Alpine, and OpenSUSE/SLES.

Multi-Init System Support: Gracefully stops and disables services for systemd, OpenRC, and SysVinit.

Removes cloudflared binary (/usr/local/bin/cloudflared).

Removes service definition files (.service for systemd, init.d scripts for others).

Attempts to remove cloudflared if it was installed via a package manager (apt, dnf/yum, pacman, apk, zypper).

Backs up and removes /etc/cloudflared (configurations) and /var/log/cloudflared (logs).

Optional: Prompts to delete active tunnels from your Cloudflare account (requires CLOUDFLARE_API_TOKEN and jq).

Optional: Prompts to remove the cloudflared user account.

Removes the setup helper script (/usr/local/bin/cloudflared-setup).

Includes a root privilege check.

Usage:
sudo ./05_uninstall_cloudflare.sh

5. un-pre.sh - Prerequisites Rollback

This script reverses the changes made by 01-pre.sh, removing packages, directories, and the user created during the prerequisite installation. It relies on the log file generated by 01-pre.sh.

Features:

Reads the installation log (/tmp/cloudflare_prereq_install.log) to identify changes.

Removes packages installed by 01-pre.sh.

Removes directories created by 01-pre.sh.

Removes the cloudflared user account.

Cleans up package cache.

Includes a root privilege check.

Usage:
sudo ./un-pre.sh

üõ†Ô∏è Installation Workflow

Follow these steps to install and configure Cloudflare Tunnel on your system:

Install Prerequisites:
sudo ./01-pre.sh

Set Cloudflare API Credentials:
Ensure you have your Cloudflare API Token and Account ID. You can set them as environment variables:
export CLOUDFLARE_API_TOKEN="YOUR_GLOBAL_API_TOKEN_OR_SCOPED_TOKEN"
export CLOUDFLARE_ACCOUNT_ID="YOUR_CLOUDFLARE_ACCOUNT_ID"


CLOUDFLARE_API_TOKEN: Generate this from your Cloudflare dashboard under "My Profile" > "API Tokens". Create a token with "Cloudflare Tunnel:Edit" permissions.

CLOUDFLARE_ACCOUNT_ID: Found in the right sidebar of any domain in your Cloudflare dashboard.

Verify Cloudflare Access:
./02-access_check.sh


This step is crucial to ensure your credentials are correct before proceeding.

Install Cloudflare Tunnel:
sudo ./03_install_cloudflare.sh

Create Your Cloudflare Tunnel:
The 03_install_cloudflare.sh script creates a helper script cloudflared-setup. Run this to create your tunnel and initial configuration:
sudo cloudflared-setup


Follow the prompts to name your tunnel. This will create the tunnel, generate its credentials file (/etc/cloudflared/YOUR_TUNNEL_ID.json), and create a basic config.yml in /etc/cloudflared/.

Configure Your Tunnel (IMPORTANT!):
Edit the generated configuration file to define your ingress rules (which local services to expose):
sudo nano /etc/cloudflared/config.yml


Refer to the config.yml.sample for examples. A common setup looks like this:

tunnel: YOUR_TUNNEL_ID
credentials-file: /etc/cloudflared/YOUR_TUNNEL_ID.json

ingress:
  - hostname: myapp.yourdomain.com
    service: http://localhost:80
  - hostname: ssh.yourdomain.com
    service: ssh://localhost:22
  - service: http_status:404 # Catch-all rule

Create DNS Records:
After configuring config.yml, create the necessary DNS records in your Cloudflare dashboard. The cloudflared-setup script will give you an example command like:
cloudflared tunnel route dns YOUR_TUNNEL_NAME subdomain.yourdomain.com


Replace subdomain.yourdomain.com with your desired hostname.

Start and Enable the Cloudflare Tunnel Service:
# For systemd-based systems (most common)
sudo systemctl enable --now cloudflared
sudo systemctl status cloudflared

# For OpenRC-based systems (e.g., Alpine, Gentoo)
sudo rc-update add cloudflared
sudo rc-service cloudflared start
sudo rc-service cloudflared status

# For SysVinit-based systems (older Debian/RHEL)
sudo service cloudflared start
sudo service cloudflared status

Check Logs:
For systemd, you can view logs with:
sudo journalctl -u cloudflared -f


For other init systems, logs might be in /var/log/cloudflared/cloudflared.log or similar.

üóëÔ∏è Uninstallation Workflow

To completely remove Cloudflare Tunnel from your system:

Run the Uninstallation Script:
sudo ./05_uninstall_cloudflare.sh


This script will prompt you for confirmation and offer to delete remote tunnels and the cloudflared user.

Rollback Prerequisites (Optional):
If you wish to remove the packages and user installed by 01-pre.sh, run:
sudo ./un-pre.sh

‚ö†Ô∏è Important Notes

Root Privileges: Most scripts require sudo to run.

Backups: The installation and uninstallation scripts create backups of existing files and configurations in /tmp/cloudflare_backup. Review these if you need to restore anything.

API Token Security: Keep your Cloudflare API Token secure. Do not hardcode it directly into scripts unless absolutely necessary for testing, and ensure it's not committed to version control. Use environment variables as recommended.

DNS Records: Remember to manage DNS records in your Cloudflare dashboard. The uninstallation script can attempt to delete tunnels, but DNS records might need manual cleanup.

jq dependency: The 02-access_check.sh and 05_uninstall_cloudflare.sh scripts use jq for parsing JSON output from Cloudflare API. While not strictly required for basic functionality, it enhances output readability and tunnel deletion. You might need to install it:

Debian/Ubuntu/Armbian: sudo apt-get install -y jq

CentOS/RHEL/Fedora: sudo yum install -y jq or sudo dnf install -y jq

Arch/Manjaro: sudo pacman -Sy --noconfirm jq

Alpine: sudo apk add jq

OpenSUSE/SLES: sudo zypper install -y jq

Feel free to contribute or report issues!
